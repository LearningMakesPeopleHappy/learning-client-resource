# HTTP详解2【进阶】

## HTTP消息的方法

《HTTP详解2》中我们只是简单了了解了一下在根据HTTP协议生成的消息中第一行第一部分的方法类型，以及常用的**GET**方法。下面我们介绍一下所有支持的方法。

### GET

通常用于请求获取资源（文件），对于加载一个网页来说，网页本质就是一个HTML文件，所以我们使用**GET**方法来加载网页。

**GET**方法也常用于获取样式、脚本、图片、音频、视频等。

**GET**方法在文件路径后可以拼接一些自定义的请求消息，但是有长度限制。

### POST

通常用于请求获取数据（JSON、XML等）。而实际上前面的这句话是不准确的，**POST**方法在定义中的目的就是为了向服务器传递消息，而不是接收消息。但是在实际使用过程中，因为下面讲解的优势，**POST**方法往往被用来作为**GET**方法的替代，作为与服务器沟通的方式。

**POST**方法和**GET**一样，也可以在文件路径后拼接一些自定义的请求消息，同样有长度限制。但是**POST**还有一个消息体部分，与HTTP请求消息的头部使用空行分隔，在其下面部分。消息体中的内容大小是没有限制的（理论上）。所以当我们因为要给服务器传递的自定义消息内容过大时，可以使用**POST**方法来传递。

> **注意：**虽然**POST**可以替代**GET**，但是加载网页、音频、图片等资源时无法替代**GET**。

### HEAD

**HEAD**方法和GET方法基本一样，唯一的区别就是在服务器并不返回资源内容，只是返回一个消息告知对应资源的有效性和更新日期等信息。

**HEAD**一般是用于查询文件缓存的，这个我们在之后讲述。

### PUT

定义中，**PUT**方法是用来上传文件到服务器的。但是呢，在HTTP协议的1.1版本中，**PUT**方法本身是没有验证机制的，也就是说只要服务器支持了这个方法，任何人都可以通过这个方法上传文件，这并不安全，所以一般大家并不选择使用这种方式上传文件。又因为POST方法带有验证机制，并且消息体部分不限制长度，所以往往使用POST方法上传文件。

### DELETE

**DELETE**方法是与**PUT**方法作用相反的一个方法，用于删除服务器上的文件，所以它与**PUT**方法一样是没有验证机制的。我们通常会采用**GET**或**POST**方法通过传输自定义消息的方式替代这个方法。

### OPTIONS

**OPTIONS**方法就是询问服务器对应指定的资源，都支持哪几种HTTP方法。

> 只在HTTP/1.1版本中支持。

### TRACE

**TRACE**方法比较复杂，几乎用不到，并且还容易引发XST攻击，所以暂时不做讲解了。

> 只在HTTP/1.1版本中支持。

### CONNECT

**CONNECT**方法在日常的浏览网页中是不会用到的，所以也不做讲解了。

> 只在HTTP/1.1版本中支持。



## Header字段说明

> **说明**：当一个字段名对应多个值的时候，一般使用逗号（`,`）分隔。值分为两部分，指令和参数，通过等号（`=`）分隔。一般参数都是可选的。
>
> **注意**：当出现重复字段时，不同的浏览器处理方式不一样，所以不要出现相同的字段。

### 通用

请求和响应都可以拥有的字段。

| 字段名                          | HTTP版本 | HTTP版本 | 说明                                                         |
| ------------------------------- | -------- | -------- | ------------------------------------------------------------ |
| [Cache-Control](#Cache-Control) |          | 1.1      | 控制缓存机制。                                               |
| Connection                      |          | 1.1      |                                                              |
| Date                            | 1.0      | 1.1      |                                                              |
| Pragma                          | 1.0      | 1.1      | HTTP/1.1中兼容HTTP/1.0的保留字段，用于处理`no-cache`，`Pragma: no-cache`等同于`Cache-Control: no-cache`。 |
| Trailer                         |          | 1.1      | 指定在消息体后（分块长度0后）设置了哪些头部字段。            |
| Transfer-Encoding               |          | 1.1      | 传输消息体时采用的编码方式，仅对分块传输编码有效。           |
| Upgrade                         |          | 1.1      |                                                              |
| Via                             |          | 1.1      |                                                              |
| Warning                         |          | 1.1      |                                                              |

#### Cache-Control

**缓存请求**

* **no-cache**
    * 无参。
    * 下次请求强制向服务器再次请求资源。一般用于告知缓存服务器不使用缓存，而是强制从服务器获取资源。
* **no-store**
    * 无参。
    * 不缓存请求或响应的任何内容。
* **max-age=[`秒`]**
    * 必须参数。
    * 响应最大的Age。一般用于告知缓存服务器，这个资源的缓存时间如果没超过给定时间，那么就将这个资源的缓存返回回来。HTTP/1.1中会优先处理这个指令而忽略`Expires`头部字段，HTTP/1.0中会优先处理`Expires`头部字段而忽略`max-age`指令。
* **max-stale=[`秒`]**
    * 可选参数。
    * 接收已过期的响应。返回的资源无落是否过期，只要这个资源开始缓存的时间到当前时间的秒数在参数指定的秒数内都可返回。如果未指定参数，则无论是过期多久的资源都可以返回。
* **min-fresh=[`秒`]**
    * 必须参数。
    * 期望在指定时间内响应。让服务器返回指定时间内不过期的资源。即，如果指定`60`，则服务器会返回60秒内都有效的资源。
* **no-transform**
    * 无参。
    * 代理不可更改媒体类型。
* **only-if-cached**
    * 无参。
    * 从缓存获取资源。只从缓存服务器获取缓存内容，如果缓存服务器不存在这个资源的缓存则返回状态码`504`。缓存服务器不会向服务器请求这个资源。
* **cache-extension**
    * 扩展指令。
    * 新指令标记（token）。扩展的指令只对能识别的服务器有效。

**缓存响应**

* **public**
    * 无参。
    * 可向任意方提供响应的缓存。一般针对于缓存服务器，指的是缓存服务器可以将这个缓存内容在有效期内提供给任何访问者。
* **private**
    * 无参。
    * 仅向特定用户返回响应。一般针对于缓存服务器，指的是缓存服务器只能将这个缓存内容再有效期内提供给当前请求者（即，当前请求者下次再请求这个资源时，如果资源缓存未过期，则返回这个资源的缓存。如果其他请求者请求这个资源，则应该访问服务器获取。）。
* **no-cache**
    * 无参。
    * 缓存前必须先确认其有效性。告知接收方再次使用这个资源的时候应该先发送请求给服务器确认这个资源的缓存是否过期。如果这个指令有参数，则表示不应该对该参数同名的响应头部字段进行缓存。
* **no-store**
    * 无参。
    * 不缓存请求或响应的任何内容。
* **no-transform**
    * 无参。
    * 代理不可更改媒体类型。可以防止代理服务器压缩图片等操作。
* **must-revalidate**
    * 无参。
    * 可缓存但必须再向服务器进行确认。表示缓存服务器应该每次都向服务器询问缓存是否过期，如果服务器无应答，则缓存服务器应该扔掉这次缓存。使用这条指令会忽略请求中的`max-stale`指令。
* **proxy-revalidate**
    * 无参。
    * 要求中间缓存服务器对缓存的响应有效性再进行确认。表示所有缓存服务器应该每次都向服务器询问缓存是否过期。
* **max-age=[`秒`]**
    * 必须参数
    * 响应的最大Age。即返回的资源缓存的最长时间。HTTP/1.1中会优先处理这个指令而忽略`Expires`头部字段，HTTP/1.0中会优先处理`Expires`头部字段而忽略`max-age`指令。
* **s-maxage=[`秒`]**
    * 必须参数
    * 公共缓存服务器响应的最大Age值。即返回的资源缓在缓存服务器中存的最长时间。缓存服务器会优先处理这个指令而忽略`Expires`头部字段和`max-age`指令。
* **cache-extension**
    * 扩展指令。
    * 新指令标记（token）。只对能识别的缓存服务器、代理服务器、客户端有效。

#### Connection

- 当Connection的值为其他的头部字段名时，表示通知代理服务器，将这个字段名舍弃之后再转发。

- 发送请求时，Connection的值可以为Keep-Alive，表示在HTTP/1.0中使用持久链接。
- 当前链接为持久链接时，服务器返回响应或发送消息时，Connection的值可以为close，表示服务器想要断开这个持久链接。

#### Date

创建HTTP报文的时间。

时间有三种格式：

* HTTP/1.1中为：`Date: Tue, 03 Jul 2012 04:40:59 GMT`。
* HTTP/1.0中为：`Date: Tue, 03-Jul-12 04:40:59 GMT`。
* C标准库的asctime()格式：`Date: Tue Jul 03 04:40:59 2012`。

#### Upgrade

用于询问服务器是否可以使用更高版本的协议进行通信。必须配合Connection字段使用，即：

```
Upgrade: TLS/1.0
Connection: Upgrade
```

因此，这个字段只在相邻的服务器之间适用。

服务器可以使用状态码101（Switching Protocols）作为响应。

#### Via

消息在通过代理服务器和网关时会在这个字段中添加自己的信息，然后再进行转发。这样既可以追踪消息转发，还可以避免请求回环。

添加的消息格式是：`1.1 a1.example.com(Squid/2.7)`

表示的是`a1.example.com`这个代理服务器（网关）使用HTTP/1.1接收到这条消息。

每条信息使用逗号（`,`）分隔。

#### Warning

这个字段是由HTTP/1.0中的`Retry-After`字段演化过来的，一般用于告知一些缓存方面的警告。

格式：`Warning: [警告码] [警告的主机:端口号] "[警告的内容]" [日期时间]`。

其中“日期时间”可选

以下列出HTTP/1.1中定义的警告，之后有可能会扩充。

| 警告码 | 警告内容                                          | 说明                                                         |
| ------ | ------------------------------------------------- | ------------------------------------------------------------ |
| 110    | Response is stale（响应已过期）                   | 代理返回已过期的资源。                                       |
| 111    | Revalidation failed（再验证失败）                 | 代理再验证资源有效性时失败。                                 |
| 112    | Disconnection operation（断开连接操作）           | 代理与互联网连接被故意切断。                                 |
| 113    | Heuristic expiration（试探性过期）                | 响应的使用期超过24小时（有效缓存的设定时间大于24小时的情况下） |
| 199    | Miscellaceous warning（杂项警告）                 | 任意的警告内容                                               |
| 214    | Transformation applied（使用了转换）              | 代理对内容编码或媒体类型等执行了某些处理时                   |
| 299    | Miscellaneous  persistent warning（持久杂项警告） | 任意的警告内容                                               |



### 请求

请求消息可用的字段。

| 字段名              | HTTP版本 | HTTP版本 | 说明 |
| ------------------- | -------- | -------- | ---- |
| Accept              |          | 1.1      |      |
| Accept-Charset      |          | 1.1      |      |
| Accept-Encoding     |          | 1.1      |      |
| Accept-Language     |          | 1.1      |      |
| Authorization       | 1.0      | 1.1      |      |
| Expect              |          |          |      |
| From                | 1.0      | 1.1      |      |
| Host                |          | 1.1      |      |
| If-Match            |          | 1.1      |      |
| If-Modified-Since   | 1.0      | 1.1      |      |
| If-None-Match       |          | 1.1      |      |
| If-Range            |          |          |      |
| If-Unmodified-Since |          | 1.1      |      |
| Max-Forwards        |          |          |      |
| Proxy-Authorization |          |          |      |
| Range               |          | 1.1      |      |
| Referer             | 1.0      | 1.1      |      |
| TE                  |          |          |      |
| User-Agent          | 1.0      | 1.1      |      |

### 响应

响应消息可用的字段。

| 字段名             | HTTP版本 | HTTP版本 | 说明 |
| ------------------ | -------- | -------- | ---- |
| Accept-Ranges      |          | 1.1      |      |
| Age                |          |          |      |
| ETag               |          | 1.1      |      |
| Location           | 1.0      | 1.1      |      |
| Proxy-Authenticate |          |          |      |
| Retry-After        |          |          |      |
| Server             | 1.0      | 1.1      |      |
| Vary               |          |          |      |
| WWW-Authenticate   | 1.0      | 1.1      |      |

### 实体（消息体）

对消息体进行说明的字段，没有消息体时可以不写。

| 字段名           | HTTP版本 | HTTP版本 | 说明                                           |
| ---------------- | -------- | -------- | ---------------------------------------------- |
| Allow            | 1.0      | 1.1      |                                                |
| Content-Encoding | 1.0      | 1.1      |                                                |
| Content-Language |          | 1.1      |                                                |
| Content-Length   | 1.0      | 1.1      |                                                |
| Content-Location |          | 1.1      |                                                |
| Content-MD5      | 1.0      | 1.1      |                                                |
| Content-Range    |          | 1.1      |                                                |
| Content-Type     | 1.0      | 1.1      | 消息体的数据类型，以MIME规定的数据类型来表示。 |
| Expires          | 1.0      | 1.1      |                                                |
| Last-Modified    | 1.0      | 1.1      |                                                |



## HTTP状态码

| 状态码      | 类别                             | 原因短语                   |
| ----------- | -------------------------------- | -------------------------- |
| [1xx](#1xx) | Informational（信息性状态码）    | 告知请求的处理进度和情况   |
| [2xx](#2xx) | Success（成功状态码）            | 请求正常处理完毕           |
| [3xx](#3xx) | Redirection（重定向状态码）      | 需要进行附加操作以完成请求 |
| [4xx](#4xx) | Client Error（客户端错误状态码） | 服务器无法处理请求         |
| [5xx](#5xx) | Server Error（服务器错误状态码） | 服务器处理请求出错         |

下面只列举常见和常用的状态码。

### 1xx



### 2xx

| 状态码 | 响应短语        | 说明                                                         |
| ------ | --------------- | ------------------------------------------------------------ |
| 200    | OK              | 从客户端发来的请求在服务器被正常的处理了。                   |
| 204    | No Content      | 服务器接收的请求已正常处理，但是返回的响应中没有任何消息体（报文主体）内容。 |
| 206    | Partail Content | 客户端对请求的内容进行了范围限定，服务器也返回了对应范围的内容。 |

### 3xx

| 状态码 | 响应短语           | 说明                                                         |
| ------ | ------------------ | ------------------------------------------------------------ |
| 301    | Moved Permanently  | 永久重定向。表示资源已经被分配了新的URI，之后应该访问新的URI。新的URI在响应头部的Location字段中给出。 |
| 302    | No Content         | 临时重定向。表示资源已经被分配了新的URI，本次应该访问新的URI。新的URI在响应头部的Location字段中给出。 |
| 303    | See Other          | 请求存在另外的URI，应使用**GET**方法访问新的URI。            |
| 304    | Not Modified       | 当客户端发送的请求附带一些条件（请求头部中的`If-Match`、`If-Modified-Since`、`If-None-Match`、`If-Range`、`If-Unmodified-Since`），但是服务端未认可这些条件。一般用于处理文件缓存，服务器表示文件未更改，可以直接使用缓存中未过期的文件。 |
| 307    | Temporary Redirect | 临时重定向。表示资源已经被分配了新的URI，本次应该访问新的URI。 |

### 4xx

| 状态码 | 响应短语     | 说明                                                         |
| ------ | ------------ | ------------------------------------------------------------ |
| 400    | Bad Request  | 请求消息中存在语法错误，应修改请求后再次发送。（浏览器中会像`200`状态码一样对待本次请求。） |
| 401    | Unauthorized | 发送的请求需要有通过HTTP认证（BASIC认证、DIGEST认证）的认证信息。如果之前有过一次`401`的请求，那么本次表示用户认证失败。浏览器一般会在第一次出现`401`时弹出对话认证窗口。 |
| 403    | Forbidden    | 服务器拒绝本次请求。                                         |
| 404    | Not Found    | 服务器上没有本次请求的资源。                                 |

### 5xx

| 状态码 | 响应短语              | 说明                                           |
| ------ | --------------------- | ---------------------------------------------- |
| 500    | Internal Server Error | 服务器在执行请求时发生了错误。                 |
| 503    | Service Unavailable   | 服务器处于超负载或停机维护，当前无法处理请求。 |

