# Vue2.5.0源码通读 - 1

Vue版本为2.5.0。



首先我们通过根目录下的`package.json`文件找到`scripts`字段下的`build`字段，这里的值所对应的`build/build.js`文件将是我们阅读Vue源码的入口。

> 为什么不选择`main`字段下的文件呢？因为这个`package.json`文件主要是用于发布npm的，`main`字段所对应的是npm库中对应的起始文件——也就是打包后的`dist`文件夹下的`vue.runtime.common.js`文件。

`build/build.js`文件中起始的代码先检查了根目录下的`dist`文件夹是否存在，不存在就创建它：

```javascript
if (!fs.existsSync('dist')) {
  fs.mkdirSync('dist')
}
```

之后我们通过读取`build/config`文件中的配置信息获取到我们打包用的配置和插件信息。

`build/config`文件里面有一个`builds`常量存放了<u>需要打包的文件</u>——这是一个对象，`key`是需要打包的文件的名称，值是一个配置对象：

* **entry:** 是<u>需要打包的文件</u>的位置。
* **dest:** <u>需要打包的文件</u>打包完成后的文件的位置。
* **format:** 是文件格式化的标准。
* **banner:** 打包完成后的文件的头部注释说明。
* **alias:** 
* **env:** 表示<u>需要打包的文件</u>应该在什么运行环境中打包。
* **external:** <u>需要打包的文件</u>在打包时需要的外部依赖库。
* **moduleName:** <u>需要打包的文件</u>在打包之后的名称。
* **plugins:** <u>需要打包的文件</u>在打包时需要的插件。
* **weex:** 是否在`weex`下使用的插件。

之后遍历对`builds`常量做处理生成标准的`rollup`配置选项格式：

* **input:** 包的入口点。`builds`元素的`entry`字段内容。
* **external:** 外部依赖。`builds`元素的`external`字段内容。
* **plugins:** 插件。这是一个数组，包含了这些元素：
    * `replace()` - `rollup-plugin-replace`
    * `flow()` - `rollup-plugin-flow-no-whitespace`
    * `buble()` - `rollup-plugin-buble`
    * `alias()` - `rollup-plugin-alias`
    * `builds`元素的`plugins`字段内容
    * 如果`builds`元素有`env`字段，那么这里用`replace()`方法处理`{'process.env.NODE_ENV': JSON.stringify(opts.env) }`之后添加进来。
* **output:** 一个对象：
    * `file` - 要写入的文件。`builds`元素的`dest`字段内容。
    * `format` - 生成包的格式。`builds`元素的`format`字段内容。`cjs`表示`CommonJS`；`umd`表示通用模块定义，以`amd`，`cjs` 和 `iife` 为一体；`es`表示保存为 ES 模块文件。
    * `banner` - `builds`元素的`banner`字段内容
    * `name` - 生成包的名称。`builds`元素的`moduleName`字段内容，如果`moduleName`字段不存在则为默认值`Vue`。
* **_name:** 这个是一个不可枚举的属性，里面是这个插件的名称。

拿到所有的`builds`之后过滤掉在`weex`环境下<u>需要打包的文件</u>。

遍历通过`rollup.rollup()`处理配置。第一个`then`里面获取到`bundle`，通过`bundle.generate()`设置`rollup`的输出参数。第二`then`中获取到处理之后的`code`，如果输出的目标文件是`.min.js`，那么就使用`uglify-js`压缩代码后写入目标文件，否则就直接写入目标文件。

写入目标文件后，如果之前用`uglify-js`压缩过代码，那么在使用Node的`zlib.gzip()`压缩代码。（这句代码只是为输出目标大小？？？蜜汁操作）

综上，我们能够知道在`build/config`的`builds`常量里面存放了需要打包的源代码，那么我们就从第一个文件`src/platforms/web/entry-runtime.js`开始看起。

